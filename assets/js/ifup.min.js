var currentUser=!1,service=!1,secondUser=!1,StartDate=!1,StopDate=!1,page=!1,d=new Date,time=!1,notif=!1,timerate=0,styles=[{featureType:"landscape",stylers:[{visibility:"on"},{color:"#bdc3c7"},{lightness:60}]},{featureType:"road.highway",stylers:[{visibility:"simplified"},{hue:"#7700ff"},{lightness:20}]},{featureType:"water",stylers:[{color:"#3498db"},{lightness:15},{visibility:"simplified"}]},{featureType:"transit",stylers:[{visibility:"simplified"},{hue:"#7700ff"},{saturation:10}]},{featureType:"poi.park",
stylers:[{color:"#59B9B1"}]}];function getPage(){page=$("#page").val();console.log(page);"index"==page?id="map-if":("mode-up"!=page&&setUserOffline(),id="map-other")}function getLocation(){if(navigator.geolocation)navigator.geolocation.getCurrentPosition(setLocation,logLocationError);else return!1}
function setLocation(a){currentUser.glat=a.coords.latitude;currentUser.glen=a.coords.longitude;console.log("User location lat = "+currentUser.glat);console.log("User location len = "+currentUser.glen);setPos();reverseGeocode();"index"==page?(setUserOnline(),currentUser.ifup_user_online=1,setUserIffer(),currentUser.ifup_user_status=0,tosend={action:"setCurrentUser",data:currentUser},tosendjson=JSON.stringify(tosend),socket.send(tosendjson)):"mode-up"==page?(setUserOnline(),currentUser.ifup_user_online=
1,setUserUpper(),currentUser.ifup_user_status=1,tosend={action:"setCurrentUser",data:currentUser},tosendjson=JSON.stringify(tosend),socket.send(tosendjson)):setUserOffline()}
function logLocationError(a){switch(a.code){case a.PERMISSION_DENIED:console.log("User denied the request for Geolocation.");break;case a.POSITION_UNAVAILABLE:console.log("Location information is unavailable.");break;case a.TIMEOUT:console.log("The request to get user location timed out.");break;case a.UNKNOWN_ERROR:console.log("An unknown error occurred.")}}
function reverseGeocode(){latlng=currentUser.glat+","+currentUser.glen;$.getJSON("https://maps.googleapis.com/maps/api/geocode/json",{latlng:latlng},function(a,b){console.log(a.results[0]);console.log(a.results[0].formatted_address);$('input[name="ifup_service_address"]').val(a.results[0].formatted_address)})}function getUser(){$.getJSON("?module=ajax&action=get-user-connect",{},function(a,b){currentUser=a;console.log(currentUser);""!=currentUser.ifup_user_firstname&&getLocation()})}
function leavePage(){console.log("leavePage init");window.onbeforeunload=function(a){(a=a||window.event)&&setUserOffline();setUserOffline()}}
function leavePageIfUp(){window.onbeforeunload=function(a){a=a||window.event;err=0==currentUser.ifup_user_status?"Votre demande \u00e0 \u00e9t\u00e9 annul\u00e9e":"Service annul\u00e9";data={ifup_user_id:currentUser.ifup_user_id,ifup_service_id:service.ifup_service_id};if(a&&null!=service.ifup_service_id)return setUserOffline(),tosend={action:"setOffline",data:data},tosendjson=JSON.stringify(tosend),console.log(tosend),socket.send(tosendjson),err="Votre demande \u00e0 \u00e9t\u00e9 annul\u00e9e",
setErr(err),err;if(null!=service.ifup_service_id)return setUserOffline(),err="Votre demande \u00e0 \u00e9t\u00e9 annul\u00e9e",tosend={action:"setOffline",data:data},tosendjson=JSON.stringify(tosend),console.log(tosend),socket.send(tosendjson),setErr(err),err}}function setUserOffline(){$.ajax({url:"?module=ajax&action=set-user-offline",type:"POST",dataType:"json",data:{userID:currentUser.ifup_user_id}}).always(function(a){console.log("setUserOffline -- "+a);currentUser.ifup_user_online=null})}
function setUserOnline(){$.ajax({url:"?module=ajax&action=set-user-online",type:"POST",dataType:"json",data:{userID:currentUser.ifup_user_id}}).always(function(a){console.log("setUserOnline -- "+a);currentUser.ifup_user_online=1})}function setUserIffer(){$.ajax({url:"?module=ajax&action=set-user-iffer",type:"POST",dataType:"json",data:{userID:currentUser.ifup_user_id}}).always(function(a){console.log("setUserIffer -- "+a);currentUser.ifup_user_status=0})}
function setUserUpper(){$.ajax({url:"?module=ajax&action=set-user-upper",type:"POST",dataType:"json",data:{userID:currentUser.ifup_user_id}}).always(function(a){console.log("setUserUpper -- "+a);currentUser.ifup_user_status=1})}
function selectUserImg(a){$.ajax({url:"?module=ajax&action=select-user-img",type:"POST",dataType:"json",data:{imageID:a}}).always(function(a){console.log("selectUserImg -- "+a.ifup_image_id);console.log("selectUserImg -- "+a.ifup_image_file);$("#span-profil").attr("src",a.ifup_image_file)})}function onPlaceChanged(){var a=this.getPlace(),b;for(b in a.address_components){var e=a.address_components[b],c;for(c in e.types){var f=document.getElementById(e.types[c]);f&&(f.value=e.long_name)}}}
function initializeAutocomplete(a){a=document.getElementById(a);var b={types:["geocode"]};a&&(a=new google.maps.places.Autocomplete(a,b),google.maps.event.addListener(a,"place_changed",onPlaceChanged))}function setPos(){if(""!=currentUser.glat&&""!=currentUser.glen){var a={lat:currentUser.glat,lng:currentUser.glen};console.log(a);map.setCenter(a)}}
function initMap(){getPage();map=new google.maps.Map(document.getElementById(id),{center:{lat:48.8587741,lng:2.2074741},zoom:17,scrollwheel:!1});map.setOptions({styles:styles});getUser()}
function initMapMeet(a){var b=new google.maps.DirectionsService,e=new google.maps.DirectionsRenderer;map=new google.maps.Map(document.getElementById("map-meet"),{center:{lat:48.9021449,lng:2.4699208},zoom:12,scrollwheel:!1});map.setOptions({styles:styles});e.setMap(map);orig=a.service.ifup_service_up_lat_len;dest=a.service.ifup_service_if_lat_len;calculateAndDisplayRoute(b,e,orig,dest);distance(orig,dest)}
function calculateAndDisplayRoute(a,b,e,c){a.route({origin:e,destination:c,travelMode:google.maps.TravelMode.DRIVING},function(a,c){c===google.maps.DirectionsStatus.OK?b.setDirections(a):window.alert("Directions request failed due to "+c)})}function distance(a,b){(new google.maps.DistanceMatrixService).getDistanceMatrix({origins:[a],destinations:[b],travelMode:google.maps.TravelMode.DRIVING,durationInTraffic:!0},distanceCallback)}
function distanceCallback(a,b){if(b==google.maps.DistanceMatrixStatus.OK)for(var e=a.originAddresses,c=0;c<e.length;c++)for(var f=a.rows[c].elements,h=0;h<f.length;h++){var g=f[h],k=g.distance.text,g=g.duration.text;console.log(k+" - "+g);$("#span-time").prepend(k+" - "+g)}}
function testSearch(){var a=[];""==$("#ifup_service_filter_id").val()&&a.push("#ifup_service_filter_id");""==$("#ifup_service_address").val()&&a.push("#ifup_service_address");""==$("#ifup_service_message").val()&&a.push("#ifup_service_message");""==currentUser.glat&&a.push("#link-if");return a}
function setService(){setServiceValues();$.getJSON("https://maps.googleapis.com/maps/api/geocode/json",{address:service.ifup_service_address,key:"AIzaSyCjsjm3Uxe0NMzwvv0C3EcfFJ7rv0m68mY"},function(a,b){""!=a.results?(returnLat=a.results[0].geometry.location.lat,returnLng=a.results[0].geometry.location.lng,service.ifup_service_if_lat_len=returnLat+","+returnLng,void 0===a.results[0].address_components[6]?(err="L'adresse n'est pas valide, saisissez une addresse compl\u00e8te svp (ex. 2 rue Jean, 75001,Paris).",
setErr(err)):(service.ifup_service_district=a.results[0].address_components[6].short_name,console.log("Service userIF positon --\x3e "+service.ifup_service_if_lat_len),addService())):(err="L'adresse saisie n'est pas valide, ou le service est indisponible, veuillez recommencer svp :)",setErr(err))})}
function setServiceValues(){service={};service.ifup_service_filter_id=$("#ifup_service_filter_id").val();service.ifup_service_address=$("#ifup_service_address").val();service.ifup_service_message=$("#ifup_service_message").val()}
function addService(){$.ajax({url:"?module=ajax&action=add-service",type:"POST",dataType:"json",data:{ifup_service_address:service.ifup_service_address,ifup_service_message:service.ifup_service_message,ifup_service_filter_id:service.ifup_service_filter_id,ifup_service_if_lat_len:service.ifup_service_if_lat_len,userID:currentUser.ifup_user_id}}).always(function(a){"X_BD000"!=a?(service.ifup_service_id=a,leavePageIfUp(),console.log(service),tosend={action:"setService",data:service},console.log(tosend),
tosendjson=JSON.stringify(tosend),socket.send(tosendjson),time=d.getTime()):(err="Impossible de cr\u00e9er le service.",setErr(err))})}function setServiceFinish(){$.ajax({url:"?module=ajax&action=set-service-finish",type:"POST",dataType:"json",data:{ifup_service_id:service.ifup_service_id}}).always(function(a){console.log(a);service=[]})}
function selectUsersUp(){$.ajax({url:"?module=ajax&action=select-users-up",type:"POST",dataType:"json",data:{ifup_service_id:service.ifup_service_id,ifup_service_filter_id:service.ifup_service_filter_id}}).always(function(a){console.log("complete");console.log(a)})}
function setErr(a){null!=service.ifup_service_id&&setServiceFinish();setUserOffline();errPopUp(a);0==currentUser.ifup_user_status?setTimeout(function(){window.location.replace("?module=back")},5E3):setTimeout(function(){window.location.replace("?module=back&action=mode-up")},5E3)}
function errPopUp(a){a=void 0===a?"Une erreur inconnue s'est produite.":a;$("#err-container").show();$("#err-container").load("view/back/layout/errjs.back.inc.php",function(){$("#err-msg").prepend(a);$("#err-back").fadeIn("slow").promise().done(function(){$("#err-disp").fadeIn("slow")})})}
function socketErr(a){console.log("Erreur : "+a);var b,e=(new Date).getTime()-time,c=0;switch(a){case "X_BD013":6E5>e?(tosend={action:"setService",data:service},tosendjson=JSON.stringify(tosend),setTimeout(function(){socket.send(tosendjson)},5E3)):(b="Aucun utilisateur en ligne ne correspond \u00e0 votre demande, r\u00e9\u00e9sayer plus tard ! :)",c=1);break;case "X_BD013bis":b="Aucun utilisateur n'est int\u00e9rr\u00e9ss\u00e9 par votre demande, r\u00e9\u00e9sayer plus tard ! :)";c=1;break;case "X_GMZIP":b=
"L'adresse n'est pas valide, saisissez une addresse compl\u00e8te svp (ex. 2 rue Jean, 75001,Paris).";c=1;break;case "X_SV000":b="Le service \u00e0 d\u00e9j\u00e0 \u00e9t\u00e9 accept\u00e9 par une autre personne, prenez le prochain ! :D";c=1;break;case "X_SV000bis":$err="Le service \u00e0 d\u00e9j\u00e0 \u00e9t\u00e9 accept\u00e9 par une autre personne, prenez le prochain ! :D (bis)";c=1;break;case "X_BD111":b="Il y a eu un probl\u00e8me, impossible de s\u00e9lectionner le service :(";c=1;break;
case "X_BDH10":b="Le second utilisateur \u00e0 mis fin au service. Tous les \u00e9changes ont \u00e9t\u00e9 arr\u00e9t\u00e9s. Retour au menu principale.";c=1;break;case "X_BD020":console.log("X_BD020"),a={ifup_service_id:service.ifup_service_id,ifup_user_id:currentUser},tosend={action:"startService",data:a},tosendjson=JSON.stringify(tosend),console.log(tosend),socket.send(tosendjson)}1==c&&(setErr(b),console.log(b))}
function setCandidates(a){console.log("Utilisateurs trouv\u00e9s : "+a);setTimeout(function(){$("#wainting-if .ctr").empty().prepend("Nous avons trouv\u00e9 "+a+" utilisateur(s) correspondants \u00e0 votre demande.");$("#loading").css("animation-timing-function","ease")},1E3)}
function setNotif(a){console.log(a);$("#err-container").load("view/back/layout/notifjs.back.inc.php",function(){$("#notif-filter").prepend(a.filter.ifup_filter_name);$("#notif-district").prepend(a.district.ifup_district_name);$("#notif-address").prepend(a.address);$("#notif-msg").prepend(a.msg);$("#err-container").show();$("#err-back").fadeIn("slow").promise().done(function(){$("#err-disp").fadeIn("slow")})});notif={ifup_service_id:a.serviceID,user:currentUser}}
function setMeeting(a){console.log(a);service=a.service;filter=a.filter;district=a.district;user=0==currentUser.ifup_user_status?a.userUP:a.userIF;leavePageIfUp();$("#err-container").fadeOut("slow",function(){$("#content-container").load("view/back/meeting.php #meeting",{},function(){$("#span-name").prepend(user.ifup_user_firstname);$("#span-msg").prepend(service.ifup_service_message);$("#span-filter").prepend(filter.ifup_filter_name);$("#span-address").prepend(service.ifup_service_address);$("#span-phone").prepend(user.ifup_user_phone);
0==currentUser.ifup_user_status?($("#start-legend").prepend(user.ifup_user_firstname+" est arriv\u00e9(e) ?"),$("#start-button-container").prepend('<a href="#!" class="btn" id="start-button">Appuyez ici pour d\u00e9marrer !</a>')):($(".links").not($("#link-up")).fadeOut("slow"),$("#link-cancel").fadeIn());initMapMeet(a);a.userIF.ifup_user_id==currentUser.ifup_user_id?selectUserImg(a.userUP.ifup_user_image_id):selectUserImg(a.userIF.ifup_user_image_id)})})}
function setCount(a){console.log(a);userUP=a;now=a.now;$("#content-container").hide("slow",function(){$("#content-container").load("view/back/count.php",{},function(){$("#content-container").fadeIn("slow",function(){});$("#count-tarif").prepend(userUP.ifup_user_time_rate);0==currentUser.ifup_user_status&&($("#count-legend").prepend("Le service est termin\u00e9 ?"),$("#count-btn").prepend('<a href="#!" class="btn" id="stop-button">Appuyez ici !</a>'))})});var b=0,e=0,c=0;temps=setInterval(function(){c++;
59<c&&(e++,c=0);59<e&&(b++,e=0);timerateM=userUP.ifup_user_time_rate/60*e;timerateH=userUP.ifup_user_time_rate*b;timerate=timerateH+timerateM;timerate=Math.round(100*timerate)/100;$("#sec").empty().prepend(dchiffre(c));$("#min").empty().prepend(dchiffre(e));$("#heu").empty().prepend(dchiffre(b));$("#count-price").empty().prepend(timerate)},1E3)}function dchiffre(a){10>a&&(a="0"+a);return a}
function setFinish(a){err=0==currentUser.ifup_user_status?"Vous devez "+a.price+"\u20ac \u00e0 "+a.firstname+" pour ce service :) </br> A bient\u00f4t !":a.firstname+" vous doit "+a.price+"\u20ac pour ce service :) </br> A bient\u00f4t !";setErr(err)}var socket=new WebSocket("ws://dev.etudiant-eemi.com:8000/ifup");socket.onmessage=function(a){decode=$.parseJSON(a.data);action=decode.action;data=decode.data;if("function"==typeof window[action])window[action](data)};console.log=function(){};
$(window).load(function(){initializeAutocomplete("ifup_service_address");leavePage()});
$("#search").submit(function(a){a.preventDefault();console.log("--------------------------------");console.log("SEARCH SUBMIT");console.log("--------------------------------");a=testSearch();if(""==a)$("#mode-ifup").fadeOut("slow",function(){$("#content-container").load("view/back/waiting-if.php #wainting-if");$(".links").not($("#link-if")).fadeOut("slow");$("#link-cancel").fadeIn()}),setService(),console.log(service);else for(var b=a.length-1;0<=b;b--)console.log(a[b]),$(a[b]).css("border","3px solid #e74c3c")});
$("#link-cancel").click(function(a){data={ifup_user_id:currentUser.ifup_user_id,ifup_service_id:service.ifup_service_id};tosend={action:"setOffline",data:data};tosendjson=JSON.stringify(tosend);console.log(tosend);socket.send(tosendjson);err="Votre demande \u00e0 \u00e9t\u00e9 annul\u00e9e";setErr(err)});var accepted=0;
$(document).on("click","#notif-accept",function(a){a.preventDefault();0==accepted&&(tosend={action:"acceptService",data:notif},tosendjson=JSON.stringify(tosend),console.log(tosend),socket.send(tosendjson),accepted=1)});$(document).on("click","#notif-denie",function(a){a.preventDefault();$("#err-container").fadeOut("slow",function(){$("#err-container").empty()});tosend={action:"denieService",data:notif};tosendjson=JSON.stringify(tosend);console.log(tosend);notif={};socket.send(tosendjson)});
$(document).on("click","#start-button",function(a){a.preventDefault();data={ifup_service_id:service.ifup_service_id,ifup_user_id:currentUser};tosend={action:"startService",data:data};tosendjson=JSON.stringify(tosend);socket.send(tosendjson);console.log(tosend)});
$(document).on("click","#stop-button",function(a){a.preventDefault();data={ifup_service_id:service.ifup_service_id,timerate:timerate,status:currentUser.ifup_user_status};tosend={action:"stopService",data:data};tosendjson=JSON.stringify(tosend);console.log(tosend);socket.send(tosendjson)});